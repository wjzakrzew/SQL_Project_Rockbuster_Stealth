##CTE for average spent by country
WITH average_total (average) 
AS 
(SELECT AVG(total_amount_paid) AS average
FROM
(SELECT 	B.customer_id,
		B.first_name,
		B. last_name,
		D.city,
		E.country,
		SUM(A.amount) AS total_amount_paid
		
FROM payment A
INNER JOIN customer B ON A.customer_id = B.customer_id
INNER JOIN address C ON B.address_id = C.address_id
INNER JOIN city D ON C.city_id = D.city_id
INNER JOIN country E ON D.country_ID = E.country_ID
WHERE city IN ('Aurora', 'Atlixco', 'Xintai', 
	'Adoni', 'Dhule (Dhulia)', 'Kurashiki', 
	'Pingxiang', 'Sivas', 'Celaya', 'So Leopoldo') 
AND country IN('India', 'China', 'United States', 
	'Japan', 'Mexico', 'Brazil', 'Russian Federation', 
	'Philippines', 'Turkey', 'Indonesia')
GROUP BY B.customer_id, first_name, last_name, city, country
ORDER BY total_amount_paid DESC LIMIT 5))

SELECT average
FROM average_total


##CTE for top customers by country
WITH top_customer_table (country,  all_customer_count, top_customer_count) 
AS 
	(SELECT E.country,
		COUNT(DISTINCT B.customer_id) AS all_customer_count,
		COUNT(DISTINCT top_5_customers.customer_id) AS top_customer_count
FROM payment A
	INNER JOIN customer B ON A.customer_id = B.customer_id
	INNER JOIN address C ON B.address_id = C.address_id
	INNER JOIN city D ON C.city_id = D.city_id
	INNER JOIN country E ON D.country_id = E.country_id
	LEFT JOIN 
	(SELECT B.customer_id, 
			B.first_name, 
			B.last_name, 
			D.city, 
			E.country, 
			SUM(A.amount) AS total_amount_paid 
			FROM payment A INNER JOIN customer B ON A.customer_id = B.customer_id 
			INNER JOIN address C ON B.address_id = C.address_id 
			INNER JOIN city D ON C.city_id = D.city_id
			INNER JOIN country E ON D.country_id = E.country_id 
			WHERE E.country IN  ('India', 'China', 'United States', 'Japan', 'Mexico', 'Brazil',  'Russian Federation', 'Philippines', 'Turkey', 'Indonesia')  
			GROUP BY B.customer_id, B.first_name, B.last_name, D.city, E.country 
			ORDER BY total_amount_paid DESC  LIMIT 5) AS top_5_customers ON top_5_customers.country = E.country  
GROUP BY E.country
ORDER BY top_customer_count DESC, all_customer_count DESC)

SELECT country,
		all_customer_count,
		top_customer_count
FROM top_customer_table
GROUP BY 3,1,2
ORDER BY top_customer_count DESC
